<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>BroadView&trade; API Guide and Reference Manual: Creating a SouthBound Plugin</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BroadView&trade; API Guide and Reference Manual
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Welcome</span></a></li>
      <li class="current"><a href="../../pages.html"><span>BroadViewâ„¢&#160;Documentation</span></a></li>
      <li><a href="../../modules.html"><span>API&#160;Reference</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../d8/db7/OPENAPPS_GUIDE.html">Software Overview</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Creating a SouthBound Plugin </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="SB_INTRO"></a>
Introduction</h1>
<p>A southbound plugin is meant to provide means of interaction with the underlying silicon to the rest of the Agent software. The Reference Agent has an SB Plugin which uses the SDK API calls directly inside the implementation. For various reasons, this may not be desirable when the Agent is used in conjunction with an NOS. It may be preferred to route the Silicon accesses via the NOS. This chapter describes various steps involved in creating a custom SB Plugin for the BST feature.</p>
<p>Each SB Plugin or Plugin in short, consists of one or more features. Each of the features is an instrumentation feature such as BST. Each feature provides a list of functions which are used for configuring the feature in the silicon as well as for obtaining required instrumentation data from the Silicon. There is one special feature called System which will be described later in this chapter. The Plugin, along with its supported features registers with the SB Redirector component.</p>
<h1><a class="anchor" id="BST_BACKGROUND"></a>
Quick BST Backgrounder</h1>
<p>At the heart of the BST feature is a counter, buffer-count, sometime also called as a cell count, or a packet count.</p>
<p>The TD2, TH silicon has various buffers at different places called categories. The ASIC provides means to measure how each of these buffers is being utilized under a given traffic scenario. A collection of all such buffer-counts for various buffers in the ASIC is the Buffer Statistics Tracking report. This BST report is sent from the Agent to Collector either on demand and periodically.</p>
<p>The ASIC allows tracking either the current values of the buffer counts or the peak values of the buffer counts. Also, the ASIC allows some of the categories, called as realms, of the buffer tracking to be disabled.</p>
<p>The ASIC allows setting up thresholds for some of the buffers, and can raise an interrupt when the buffer usage exceeds the configured threshold.</p>
<h1><a class="anchor" id="FILES"></a>
Important Files and Folders</h1>
<p>Assuming that &lt;broadview&gt; is where the Agent source code is located, the following are various important files and folders for the Agent.</p>
<p><b>&lt;broadview&gt;/src/public/:</b> Consists of all shared declarations.<br/>
 <b>&lt;broadview&gt;/src/public/broadview.h:</b> Consists of all common definitions and common error codes. <br/>
 <b>&lt;broadview&gt;/src/public/bst.h:</b> Consists of all shared definitions for the BST feature<br/>
 <b>&lt;broadview&gt;/src/infrastructure/system/system.c :</b> Consists invocations of all initialization functions belonging to various components as part of system_init(). <br/>
 <b>&lt;broadview&gt;/src/sb_plugin :</b> Consists of all SB Plugin implementations <br/>
</p>
<h1><a class="anchor" id="ERROR_CODES"></a>
Error Codes</h1>
<p>The shared enumeration BVIEW_STATUS (located in broadview.h file) contains the error codes to be used by all the components. It is reproduced here for convenience</p>
<div class="image">
<img src="../../ErrorCode.jpg" alt="ErrorCode.jpg"/>
<div class="caption">
Error Codes</div></div>
 <h1><a class="anchor" id="DATA_STRUCTURES"></a>
Data Structures</h1>
<h1><a class="anchor" id="BVIEW_SB_PLUGIN"></a>
BVIEW_SB_PLUGIN_t</h1>
<p>A SB Plugin is described by the data structure BVIEW_SB_PLUGIN_t as follows in the file sbplugin.h. The structure is self-explanatory.</p>
<div class="image">
<img src="../../SB_PLUGIN.jpg" alt="SB_PLUGIN.jpg"/>
</div>
 <h1><a class="anchor" id="BVIEW_SB_FEATURE"></a>
BVIEW_SB_FEATURE_t</h1>
<p>A feature is described by the data structure BVIEW_SB_FEATURE_t as follows in the file sbfeature.h. The structure is self-explanatory.</p>
<div class="image">
<img src="../../SB_FEATURE.jpg" alt="SB_FEATURE.jpg"/>
</div>
 <h1><a class="anchor" id="BVIEW_SB_BST_FEATURE"></a>
BVIEW_SB_BST_FEATURE_t</h1>
<p>The BST feature is described by the data structure BVIEW_SB_BST_FEATURE_t in the file sbfeature_bst.h</p>
<div class="image">
<img src="../../SB_BST_FEATURE.jpg" alt="SB_BST_FEATURE.jpg"/>
</div>
 <div class="image">
<img src="../../SB_BST_FEATURE_2.jpg" alt="SB_BST_FEATURE_2.jpg"/>
</div>
 <div class="image">
<img src="../../SB_BST_FEATURE_3.jpg" alt="SB_BST_FEATURE_3.jpg"/>
</div>
 <div class="image">
<img src="../../SB_BST_FEATURE_4.jpg" alt="SB_BST_FEATURE_4.jpg"/>
</div>
<p> This document doesn't explain the BST feature. The reader is encouraged to consult the corresponding hardware documentation to understand the silicon functionality. The following are important aspects to be noted for this data structure.</p>
<p>The callback function pointers indicate the desired action by the instrumentation components. Each of these callbacks has a corresponding SB Redirector API which will be invoked by the Instrumentation components.</p>
<p>For example, the bst_clear_thresholds_cb function pointer corresponds to a request to clear all thresholds.</p>
<p>Each callback function pointer has an asic parameter which is an integer. This parameter identifies the ASIC on which the operation is desired. In a Single-ASIC platform, this asic parameter carries a value of 1 and should be ignored.</p>
<p>For each of the realms (categories), there is a statistics retrieval function. A pointer to a buffer (as appropriate) is passed as a parameter to the callback. The callback is expected to fill the buffer and return appropriate error code. The callback function must aggregate the data and return statistics for all entries in the realm.</p>
<p>For example, the callback function bst_ippg_data_get_cb is required to fill data with statistics from all the ports and priority groups in the realm.</p>
<p>The callback functions corresponding to Threshold set functionality are specific to a statistic. For example, the callback function bst_cpuq_threshold_set_cb is required to set the threshold for the CPU queue corresponding to the cpuq parameter.</p>
<p>The components may register a callback to be invoked when a previously configured trigger goes off. Not more than one callback may be registered.</p>
<p>Each of the statistics retrieval function must also return a time parameter, indicating the time at which the statistics are collected. If this parameter is returned as NULL, the current system time is assumed as the sample time.</p>
<p>The statistics tracking may be selectively enabled/disabled using the bst_config_set_cb callback function. Current status must be returned when the bst_config_get_cb callback function is used.</p>
<h1><a class="anchor" id="PLUGIB_IMPLEMENTATION"></a>
Plugin Implementation</h1>
<p>This section lists various steps in implementing a SB Plugin using the information provided so far.</p>
<p>1.Implement the BVIEW_SB_BST_FEATURE_t structure. This means implementing all the function required by this structure.</p>
<p>2.Implement the Feature Initialization function, where all the function pointers are initialized to the BVIEW_SB_BST_FEATURE_t structure.</p>
<div class="image">
<img src="../../Plugin_opennsl.jpg" alt="Plugin_opennsl.jpg"/>
</div>
<p> 3.Implement the BVIEW_SB_PLUGIN_t structure. This means filling in all the BVIEW_SB_BST_FEATURE_t structure pointers in the array.</p>
<div class="image">
<img src="../../Plugin_2.jpg" alt="Plugin_2.jpg"/>
</div>
<p> 4.Implement the Plugin Initialization function. This must internally call all corresponding feature plugin initialization functions.</p>
<div class="image">
<img src="../../Plugin_opennsl_3.jpg" alt="Plugin_opennsl_3.jpg"/>
</div>
<p> 5.Register the Plugin with the SB-Redirector component as part of the Plugin initialization</p>
<div class="image">
<img src="../../Plugin_opennsl_4.jpg" alt="Plugin_opennsl_4.jpg"/>
</div>
<p>6.Place the call to Plugin Initialization inside the system_init function in system.c file. Note that the Plugin can be initialized only after the SB-Redirector is initialized.</p>
<div class="image">
<img src="../../Plugin_5.jpg" alt="Plugin_5.jpg"/>
</div>
<p> 7.The default settings for the BST buffers are mentioned in the platform.h file. NOS need to change these values per the configured settings.</p>
<div class="image">
<img src="../../td2_default_settings.jpg" alt="td2_default_settings.jpg"/>
</div>
 <h1><a class="anchor" id="SYSTEM_FEATURE"></a>
System Feature</h1>
<p>The SB Plugin supports a feature called System. This feature is used for obtaining relevant information from the underlying NOS. The current definition of the feature is limited to few callbacks meant for obtaining system information and those required for translating port number representation to and from SDK notation to the user notation. The data structure BVIEW_SB_SYSTEM_FEATURE_t is defined in sbplugin_system.h file as follows.</p>
<div class="image">
<img src="../../system.jpg" alt="system.jpg"/>
</div>
<p> The port / unit number translation is used as follows:</p>
<p>When the statistics are obtained from the silicon and a (partial or full) snapshot report is prepared, before the data is sent to user, all the port numbers are converted from the SDK notation to the user notation. So the REST carries JSON reports with user notation for port numbers. This is also valid for unit numbers.</p>
<p>When a configuration request is received by the REST, while converting the JSON data to C structure, the port numbers and unit numbers are automatically converted from user notation to SDK notation.</p>
<p>The default implementation of these callbacks doesn't provide any real mapping service. However, if any specific representation mapping is desired, corresponding callbacks may be implemented. SB-Redirector component ensures that there can be only one System Feature among the Plugins that are registered with it.</p>
<h1><a class="anchor" id="ADDITIONAL"></a>
Additional Considerations</h1>
<p>When integrating with an NOS, it is likely that the silicon accesses are routed through the NOS. In such cases, it must be noted that the amount of data that is required for statistics collection is big. If the Plugin-NOS communication is sub-optimal, it is very likely to choke the entire system while snapshot reports are being prepared. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Sep 30 2015 18:57:39 for BroadView&trade; API Guide and Reference Manual by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.2
</small></address>
</body>
</html>
